// üìÖ –ü—Ä–µ–º–∏—è –∑–∞ –º–µ—Å—è—Ü ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
document.getElementById('checkMonthBtn').addEventListener('click', async () => {
  // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ allowed_users
  const {  data, error: userError } = await supabaseClient
    .from('allowed_users')
    .select('name')
    .eq('phone', currentUserPhone)
    .single();

  if (userError) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏:', userError);
    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
    return;
  }

  if (!data || !data.name) {
    alert('–í–∞—à–µ –∏–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é.');
    return;
  }

  const managerName = data.name;
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

  const {  data: deals, error: dealsError } = await supabaseClient
    .from('deals')
    .select('crm_id, deal_type, contract_amount, total_paid, paid, up_signed, bonus_paid, created_at')
    .eq('manager_name', managerName)
    .gte('created_at', startOfMonth.toISOString())
    .lte('created_at', endOfMonth.toISOString());

  if (dealsError) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫:', dealsError);
    alert('–û—à–∏–±–∫–∞: ' + dealsError.message);
    return;
  }

  let totalMargin = 0;
  let totalBonus = 0;

  const dealRows = deals.map(deal => {
    const margin = 
      deal.deal_type === 'to' || deal.deal_type === 'pto' || deal.deal_type === 'rent' ? deal.contract_amount * 0.7 :
      deal.deal_type === 'eq' ? deal.contract_amount * 0.2 :
      deal.deal_type === 'comp' ? deal.contract_amount * 0.3 :
      deal.deal_type === 'rep' ? deal.contract_amount * 0.4 : 0;

    totalMargin += margin;
    totalBonus += deal.bonus_paid || 0;

    const status = deal.paid ? '‚úÖ 100%' : `‚è≥ ${Math.round((deal.total_paid / deal.contract_amount) * 100)}%`;

    return `
      <tr>
        <td>${deal.crm_id}</td>
        <td>${deal.deal_type === 'to' ? '–¢–û' : deal.deal_type.toUpperCase()}</td>
        <td>${deal.contract_amount.toLocaleString('ru-RU')} ‚ÇΩ</td>
        <td>${status}</td>
        <td>${(deal.bonus_paid || 0).toLocaleString('ru-RU')} ‚ÇΩ</td>
        <td>${new Date(deal.created_at).toLocaleDateString('ru-RU')}</td>
      </tr>
    `;
  }).join('');

  const basePlan = 800000;
  const coefficients = [0.7, 1.0, 1.0, 1.0, 0.8, 1.0, 1.0, 1.0, 1.1, 1.1, 1.1, 1.4];
  const plan = basePlan * coefficients[now.getMonth()];
  const planPercent = (totalMargin / plan) * 100;

  let finalPayout = 0;
  if (planPercent >= 100) {
    finalPayout = totalBonus;
  } else if (planPercent >= 50) {
    finalPayout = Math.round(totalBonus * 0.5);
  }

  const resultDiv = document.getElementById('monthResult');
  resultDiv.innerHTML = `
    <h3>–ü—Ä–µ–º–∏—è –∑–∞ ${now.toLocaleString('ru-RU', { month: 'long', year: 'numeric' })}</h3>
    <div style="background:#f0f9ff; padding:12px; border-radius:6px; margin-bottom:15px;">
      <strong>–ü–ª–∞–Ω –ø–æ –º–∞—Ä–∂–µ:</strong> ${plan.toLocaleString('ru-RU')} ‚ÇΩ<br>
      <strong>–ù–∞–±—Ä–∞–Ω–æ –º–∞—Ä–∂–∏:</strong> ${totalMargin.toLocaleString('ru-RU')} ‚ÇΩ (${planPercent.toFixed(1)}%)<br>
      <strong>–ù–∞—á–∏—Å–ª–µ–Ω–æ –ø—Ä–µ–º–∏–π:</strong> ${totalBonus.toLocaleString('ru-RU')} ‚ÇΩ<br>
      <strong>–ö –≤—ã–ø–ª–∞—Ç–µ:</strong> ${finalPayout.toLocaleString('ru-RU')} ‚ÇΩ
    </div>
    <h4>–°–¥–µ–ª–∫–∏ (${deals.length} —à—Ç):</h4>
    <div style="max-height:300px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>CRM ID</th>
            <th>–¢–∏–ø</th>
            <th>–î–æ–≥–æ–≤–æ—Ä</th>
            <th>–û–ø–ª–∞—Ç–∞</th>
            <th>–ü—Ä–µ–º–∏—è</th>
            <th>–î–∞—Ç–∞</th>
          </tr>
        </thead>
        <tbody>
          ${dealRows}
        </tbody>
      </table>
    </div>
  `;
  resultDiv.style.display = 'block';
});

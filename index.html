<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–µ–º–∏–π</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
--primary: #1890ff;
--success: #52c41a;
--warning: #fa8c16;
--danger: #ff4d4f;
--bg: #f9f9f9;
--card: white;
--text: #333;
--border: #e8e8e8;
--text-light: #888;
}
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
max-width: 100%;
margin: 0;
padding: 0;
background: var(--bg);
box-sizing: border-box;
}
.container {
max-width: 100%;
margin: 20px auto;
padding: 0 16px;
box-sizing: border-box;
}
h1, h2, h3, h4 {
color: var(--text);
margin-top: 0;
font-weight: 600;
}
label {
display: block;
margin-top: 12px;
font-weight: 600;
color: var(--text);
}
input, select, button, textarea {
width: 100%;
padding: 10px;
margin-top: 6px;
border: 1px solid var(--border);
border-radius: 6px;
box-sizing: border-box;
font-size: 16px;
font-family: inherit;
}
input[type="checkbox"] {
width: auto;
margin-right: 8px;
}
.result {
margin-top: 24px;
padding: 16px;
background: #e6f7ff;
border: 1px solid #91d5ff;
border-radius: 8px;
text-align: center;
font-size: 18px;
font-weight: bold;
color: var(--primary);
display: none;
}
/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.card {
background: var(--card);
border-radius: 12px;
box-shadow: 0 2px 12px rgba(0,0,0,0.06);
padding: 20px;
margin-bottom: 20px;
overflow: hidden;
}
/* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
table {
width: 100%;
border-collapse: collapse;
margin-top: 12px;
font-size: 14px;
line-height: 1.5;
}
th, td {
padding: 8px;
text-align: left;
border-bottom: 1px solid var(--border);
word-break: break-all;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
th {
background-color: #f0f9ff;
font-weight: 600;
font-size: 15px;
}
/* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
@media (max-width: 768px) {
.container {
padding: 10px;
}
.card {
padding: 16px;
}
table {
font-size: 13px;
}
th, td {
padding: 6px;
font-size: 13px;
}
.filter-row {
flex-direction: column;
gap: 10px;
}
.analytics-card {
padding: 12px;
}
.analytics-item {
min-width: 100px;
}
}
/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
.progress-bar {
height: 8px;
background: #e6f7ff;
border-radius: 4px;
overflow: hidden;
margin: 8px 0;
}
.progress-fill {
height: 100%;
background: var(--success);
border-radius: 4px;
}
/* –ö–Ω–æ–ø–∫–∏ */
button {
background: var(--primary);
color: white;
border: none;
padding: 10px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.2s;
font-size: 16px;
font-weight: 500;
}
button:hover {
opacity: 0.9;
transform: translateY(-1px);
}
button.success {
background: var(--success);
}
button.warning {
background: var(--warning);
}
button.danger {
background: var(--danger);
}
/* –°–∫—Ä–æ–ª–ª—ã */
.scrollable {
max-height: 400px;
overflow-y: auto;
margin-top: 12px;
}
/* –§–∏–ª—å—Ç—Ä—ã */
.filter-row {
display: flex;
gap: 12px;
margin: 15px 0;
flex-wrap: wrap;
}
.analytics-card {
background: #fafafa;
border-radius: 8px;
padding: 16px;
margin: 12px 0;
}
.analytics-item {
flex: 1;
min-width: 120px;
background: #fff;
padding: 12px;
border-radius: 8px;
border: 1px solid var(--border);
text-align: center;
box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}
.analytics-item .label {
font-weight: 600;
font-size: 14px;
margin-bottom: 6px;
}
.analytics-item .value {
font-size: 18px;
font-weight: bold;
color: var(--primary);
margin: 6px 0;
}
.analytics-item .percent {
font-size: 13px;
color: var(--text-light);
}
/* –ò–∫–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ */
.status-icon {
font-size: 16px;
margin: 0 4px;
}
.icon-success {
color: var(--success);
}
.icon-danger {
color: var(--danger);
}
/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚Äî —É–±–∏—Ä–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
.table-container {
overflow-x: hidden;
margin: 12px 0;
}
.table-responsive {
overflow-x: auto;
-webkit-overflow-scrolling: touch;
margin: 12px 0;
}
/* –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
.no-wrap {
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
/* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä–∂–∏ */
.margin-value {
font-weight: 600;
color: var(--primary);
}
.segment-label {
font-weight: 600;
color: var(--text);
}
.manager-label {
font-weight: 600;
color: var(--text);
}
/* –ü–æ–¥–ø–∏—Å—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ */
footer {
margin-top: 40px;
padding-top: 20px;
border-top: 1px solid var(--border);
text-align: center;
color: var(--text-light);
font-size: 14px;
font-family: 'Segoe UI', sans-serif;
background: var(--card);
padding: 12px;
}
</style>
</head>
<body>
<div class="container">
<!-- –≠–∫—Ä–∞–Ω 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div id="loginScreen" class="card">
<h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–µ–º–∏–π</h1>
<label>–í–∞—à —Ä–∞–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
<input type="text" id="loginPhone" placeholder="+79123456789">
<label>–ü–∞—Ä–æ–ª—å:</label>
<input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<button id="loginBtn">–í–æ–π—Ç–∏</button>
<div id="loginError" style="color:var(--danger); margin-top:10px; display:none;"></div>
</div>
<!-- –≠–∫—Ä–∞–Ω 2: –í–≤–æ–¥ CRM ID (–º–µ–Ω–µ–¥–∂–µ—Ä) -->
<div id="crmScreen" class="card" style="display:none;">
<h2><i class="fas fa-file-contract"></i> –†–∞–±–æ—Ç–∞ —Å–æ —Å–¥–µ–ª–∫–æ–π</h2>
<label>–ù–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏ –≤ CRM (–∏–∑ –ë–∏—Ç—Ä–∏–∫—Å):</label>
<input type="text" id="inputCrmId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12345">
<button id="checkCrmBtn" class="success">–ù–∞–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
<div id="crmError" style="color:var(--danger); margin-top:10px; display:none;"></div>
<button id="checkMonthBtn" class="warning" style="margin-top:15px;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–º–∏—é –∑–∞ –º–µ—Å—è—Ü</button>
<div id="monthResult" class="result" style="margin-top:15px;"></div>
<!-- ‚úâÔ∏è –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ -->
<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
<button id="feedbackBtn" style="background:#f0f9ff; border:1px solid #91d5ff; padding:8px 16px; border-radius:6px; cursor:pointer; color:var(--primary);">
<i class="fas fa-comment"></i> –ù–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É
</button>
<div id="feedbackForm" style="display:none; margin-top:15px; padding:15px; background:#fff; border:1px solid #ddd; border-radius:8px; max-width:500px; margin:15px auto;">
<textarea id="feedbackText" placeholder="–í–∞—à–∞ –∏–¥–µ—è, –æ—à–∏–±–∫–∞ –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏–µ..." style="width:100%; height:80px; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;"></textarea>
<button id="sendFeedbackBtn" class="success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<div id="feedbackResult" style="margin-top:10px; color:var(--success); display:none;"></div>
</div>
</div>
</div>
<!-- üîπ –≠–∫—Ä–∞–Ω –†–û–ü–∞ -->
<div id="ropScreen" class="card" style="display:none;">
<h2><i class="fas fa-user-tie"></i> –ü–∞–Ω–µ–ª—å –†–û–ü–∞</h2>
<!-- –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
<div class="filter-row">
<div style="flex:1; min-width:150px;">
<label>–ü–µ—Ä–∏–æ–¥:</label>
<select id="ropPeriod">
<option value="month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
<option value="week">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</option>
<option value="quarter">–¢–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª</option>
<option value="year">–¢–µ–∫—É—â–∏–π –≥–æ–¥</option>
</select>
</div>
<div style="flex:1; min-width:150px;">
<label>&nbsp;</label>
<button id="loadRopData">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>
</div>
<!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ -->
<button id="ropCreateDealBtn" class="success" style="margin-top:15px; width:100%;">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
<!-- –ò—Ç–æ–≥–∏ -->
<div id="ropSummary" class="result" style="display:none; text-align:left; padding:16px;">
<h3>–ò—Ç–æ–≥–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>
<p><strong>–ú–∞—Ä–∂–∞ –æ—Ç–¥–µ–ª–∞:</strong> <span id="totalMarginRop">0</span> ‚ÇΩ</p>
<p><strong>–ü—Ä–µ–º–∏—è –†–û–ü–∞:</strong> <span id="ropBonus">0</span> ‚ÇΩ</p>
<p><strong>–°–¥–µ–ª–æ–∫:</strong> <span id="totalDealsRop">0</span></p>
</div>
<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filter-row">
<div style="flex:1; min-width:150px;">
<label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
<select id="ropManagerFilter">
<option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
</select>
</div>
<div style="flex:1; min-width:150px;">
<label>–°–µ–≥–º–µ–Ω—Ç:</label>
<select id="ropSegmentFilter">
<option value="">–í—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã</option>
<option value="–¢–û">–¢–û</option>
<option value="–ü–¢–û">–ü–¢–û</option>
<option value="–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
<option value="–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</option>
<option value="–†–µ–º–æ–Ω—Ç—ã">–†–µ–º–æ–Ω—Ç—ã</option>
<option value="–ê—Ä–µ–Ω–¥–∞">–ê—Ä–µ–Ω–¥–∞</option>
</select>
</div>
<div style="flex:1; min-width:150px;">
<label>&nbsp;</label>
<button id="applyRopFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>
</div>
<!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º -->
<div id="managersAnalytics" class="analytics-card" style="display:none;">
<h4>–¢–æ–ø –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</h4>
<div id="managersChart" style="display:flex; gap:15px; flex-wrap:wrap;"></div>
</div>
<!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º -->
<div id="segmentsAnalytics" class="analytics-card" style="display:none;">
<h4>–ú–∞—Ä–∂–∞ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º</h4>
<div id="segmentsChart" style="display:flex; gap:15px; flex-wrap:wrap;"></div>
</div>
<!-- –¢–∞–±–ª–∏—Ü–∞ —Å–¥–µ–ª–æ–∫ -->
<div id="ropDealsTable" style="margin-top:20px; display:none;">
<h3>–°–¥–µ–ª–∫–∏ –æ—Ç–¥–µ–ª–∞</h3>
<div class="table-container">
<table id="ropDealsList" style="width:100%;">
<thead>
<tr>
<th>CRM ID</th>
<th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
<th>–¢–∏–ø</th>
<th>–î–æ–≥–æ–≤–æ—Ä</th>
<th>–ú–∞—Ä–∂–∞</th>
<th>–û–ø–ª–∞—Ç–∞</th>
<th>–£–ü–î</th>
<th>–î–µ–π—Å—Ç–≤–∏—è</th>
</tr>
</thead>
<tbody id="ropDealsBody"></tbody>
</table>
</div>
</div>
</div>
<!-- –≠–∫—Ä–∞–Ω 3: –§–æ—Ä–º–∞ -->
<div id="mainApp" style="display:none;">
<div id="formContainer"></div>
</div>
<!-- –ü–æ–¥–ø–∏—Å—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
<footer>
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî –ò–ª—å—è –ì–∞–ª—É–Ω–∏–Ω
</footer>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
// üîë Supabase
const supabaseUrl = 'https://ebgqaswbnsxklbshtkzo.supabase.co';
const supabaseAnonKey = 'sb_publishable_xUFmnxRAnAPtHvQ9OJonwA_Tzt7TBui';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
let currentUserPhone = null;
let currentUserRole = null;

// üìä –†–∞—Å—á—ë—Ç –ø—Ä–µ–º–∏–∏
function calculateBonus(dealType, revenue, isFirst, paid, upSigned, annualContract = false) {
  if (!paid || !upSigned) return 0;
  if (dealType === 'to') {
    if (annualContract && revenue >= 35000) {
      return Math.round(revenue * 12 * 0.03);
    }
    if (isFirst) {
      if (revenue >= 70000) return 6000;
      if (revenue >= 35000) return 3000;
      return 500;
    } else {
      if (revenue >= 70000) return 2000;
      if (revenue >= 35000) return 1000;
      return 200;
    }
  }
  if (dealType === 'pto') {
    if (revenue >= 360000) return 6000;
    if (revenue >= 90000) return 3000;
    return 1000;
  }
  if (dealType === 'comp' || dealType === 'rep') {
    if (revenue >= 300000) return Math.round(revenue * 0.01);
    return Math.round(revenue * 0.03);
  }
  if (dealType === 'eq') {
    return Math.round(revenue * 0.01);
  }
  if (dealType === 'rent') {
    return 1500;
  }
  return 0;
}

// üë§ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
document.getElementById('loginBtn').addEventListener('click', async () => {
  const phone = document.getElementById('loginPhone').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  if (!phone || !password) {
    document.getElementById('loginError').textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –ø–∞—Ä–æ–ª—å';
    document.getElementById('loginError').style.display = 'block';
    return;
  }
  const { data, error } = await supabaseClient
    .from('allowed_users')
    .select('phone, name, role')
    .eq('phone', phone)
    .eq('password', password)
    .single();
  if (error || !data) {
    document.getElementById('loginError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
    document.getElementById('loginError').style.display = 'block';
    return;
  }
  currentUserPhone = phone;
  currentUserRole = data.role;
  document.getElementById('loginScreen').style.display = 'none';
  if (data.role === 'rop') {
    document.getElementById('ropScreen').style.display = 'block';
  } else {
    document.getElementById('crmScreen').style.display = 'block';
  }
});

// üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ CRM ID
document.getElementById('checkCrmBtn').addEventListener('click', async () => {
  const crmId = document.getElementById('inputCrmId').value.trim();
  if (!crmId) {
    document.getElementById('crmError').textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏';
    document.getElementById('crmError').style.display = 'block';
    return;
  }
  const { data, error } = await supabaseClient
    .from('deals')
    .select('*')
    .eq('crm_id', crmId)
    .maybeSingle();
  if (error) {
    document.getElementById('crmError').textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message;
    document.getElementById('crmError').style.display = 'block';
    return;
  }
  if (!data) {
    showCreateForm(crmId);
  } else {
    showUpdateForm(data);
  }
});

// üìÖ –ü—Ä–µ–º–∏—è –∑–∞ –º–µ—Å—è—Ü
document.getElementById('checkMonthBtn').addEventListener('click', async () => {
  const { data, error: userError } = await supabaseClient
    .from('allowed_users')
    .select('name')
    .eq('phone', currentUserPhone)
    .single();
  if (userError) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏:', userError);
    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
    return;
  }
  if (!data || !data.name) {
    alert('–í–∞—à–µ –∏–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é.');
    return;
  }
  const managerName = data.name;
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
  const { data: deals, error: dealsError } = await supabaseClient
    .from('deals')
    .select('crm_id, deal_type, contract_amount, total_paid, paid, up_signed, bonus_paid, created_at')
    .eq('manager_name', managerName)
    .gte('created_at', startOfMonth.toISOString())
    .lte('created_at', endOfMonth.toISOString());
  if (dealsError) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–æ–∫:', dealsError);
    alert('–û—à–∏–±–∫–∞: ' + dealsError.message);
    return;
  }
  let totalMargin = 0;
  let totalBonus = 0;
  const dealRows = deals.map(deal => {
    const margin =
      deal.deal_type === 'to' || deal.deal_type === 'pto' || deal.deal_type === 'rent' ? deal.contract_amount * 0.7 :
      deal.deal_type === 'eq' ? deal.contract_amount * 0.2 :
      deal.deal_type === 'comp' ? deal.contract_amount * 0.3 :
      deal.deal_type === 'rep' ? deal.contract_amount * 0.4 : 0;
    totalMargin += margin;
    totalBonus += deal.bonus_paid || 0;
    const status = deal.paid ? '‚úÖ 100%' : `‚è≥ ${Math.round((deal.total_paid / deal.contract_amount) * 100)}%`;
    return `
      <tr>
        <td>${deal.crm_id}</td>
        <td>${
          deal.deal_type === 'to' ? '–¢–û' :
          deal.deal_type === 'pto' ? '–ü–¢–û' :
          deal.deal_type === 'eq' ? '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' :
          deal.deal_type === 'comp' ? '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ' :
          deal.deal_type === 'rep' ? '–†–µ–º–æ–Ω—Ç—ã' :
          deal.deal_type === 'rent' ? '–ê—Ä–µ–Ω–¥–∞' : deal.deal_type
        }</td>
        <td>${deal.contract_amount.toLocaleString('ru-RU')} ‚ÇΩ</td>
        <td>${status}</td>
        <td>${(deal.bonus_paid || 0).toLocaleString('ru-RU')} ‚ÇΩ</td>
        <td>${new Date(deal.created_at).toLocaleDateString('ru-RU')}</td>
      </tr>
    `;
  }).join('');
  const basePlan = 800000;
  const coefficients = [0.7, 1.0, 1.0, 1.0, 0.8, 1.0, 1.0, 1.0, 1.1, 1.1, 1.1, 1.4];
  const plan = basePlan * coefficients[now.getMonth()];
  const planPercent = (totalMargin / plan) * 100;
  let finalPayout = 0;
  if (planPercent >= 100) {
    finalPayout = totalBonus;
  } else if (planPercent >= 50) {
    finalPayout = Math.round(totalBonus * 0.5);
  }
  const resultDiv = document.getElementById('monthResult');
  resultDiv.innerHTML = `
    <h3>–ü—Ä–µ–º–∏—è –∑–∞ ${now.toLocaleString('ru-RU', { month: 'long', year: 'numeric' })}</h3>
    <div style="background:#f0f9ff; padding:12px; border-radius:6px; margin-bottom:15px;">
      <strong>–ü–ª–∞–Ω –ø–æ –º–∞—Ä–∂–µ:</strong> ${plan.toLocaleString('ru-RU')} ‚ÇΩ<br>
      <strong>–ù–∞–±—Ä–∞–Ω–æ –º–∞—Ä–∂–∏:</strong> ${totalMargin.toLocaleString('ru-RU')} ‚ÇΩ (${planPercent.toFixed(1)}%)<br>
      <strong>–ù–∞—á–∏—Å–ª–µ–Ω–æ –ø—Ä–µ–º–∏–π:</strong> ${totalBonus.toLocaleString('ru-RU')} ‚ÇΩ<br>
      <strong>–ö –≤—ã–ø–ª–∞—Ç–µ:</strong> ${finalPayout.toLocaleString('ru-RU')} ‚ÇΩ
    </div>
    <h4>–°–¥–µ–ª–∫–∏ (${deals.length} —à—Ç):</h4>
    <div style="max-height:300px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>CRM ID</th>
            <th>–¢–∏–ø</th>
            <th>–î–æ–≥–æ–≤–æ—Ä</th>
            <th>–û–ø–ª–∞—Ç–∞</th>
            <th>–ü—Ä–µ–º–∏—è</th>
            <th>–î–∞—Ç–∞</th>
          </tr>
        </thead>
        <tbody>
          ${dealRows}
        </tbody>
      </table>
    </div>
  `;
  resultDiv.style.display = 'block';
});

// ‚úâÔ∏è –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
document.getElementById('feedbackBtn').addEventListener('click', () => {
  const form = document.getElementById('feedbackForm');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
});
document.getElementById('sendFeedbackBtn').addEventListener('click', async () => {
  const message = document.getElementById('feedbackText').value.trim();
  if (!message || !currentUserPhone) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
    return;
  }
  const { error } = await supabaseClient
    .from('feedback')
    .insert([{
      phone: currentUserPhone,
      message,
      created_at: new Date().toISOString()
    }]);
  if (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  } else {
    document.getElementById('feedbackResult').textContent = '‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.';
    document.getElementById('feedbackResult').style.display = 'block';
    document.getElementById('feedbackText').value = '';
    setTimeout(() => {
      document.getElementById('feedbackForm').style.display = 'none';
      document.getElementById('feedbackResult').style.display = 'none';
    }, 2000);
  }
});

// ‚ûï –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–º–µ–Ω–µ–¥–∂–µ—Ä)
function showCreateForm(crmId) {
  document.getElementById('crmScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('formContainer').innerHTML = `
    <button id="backBtn" style="margin-bottom:15px; background:#f5f5f5; border:1px solid #ddd; padding:6px 12px; border-radius:6px; cursor:pointer;">
      <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ CRM ID
    </button>
    <h3><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É: ${crmId}</h3>
    <label>–í–∞—à–µ –∏–º—è:</label>
    <input type="text" id="manager_name" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" required>
    <label>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (‚ÇΩ):</label>
    <input type="number" id="contract_amount" placeholder="600000" required>
    <label>–°—É–º–º–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã (‚ÇΩ):</label>
    <input type="number" id="payment_amount" placeholder="140000" required>
    <label>–¢–∏–ø —Å–¥–µ–ª–∫–∏:</label>
    <select id="deal_type">
      <option value="to">–¢–û</option>
      <option value="pto">–ü–¢–û</option>
      <option value="comp">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</option>
      <option value="rep">–†–µ–º–æ–Ω—Ç—ã</option>
      <option value="eq">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
      <option value="rent">–ê—Ä–µ–Ω–¥–∞</option>
    </select>
    <div id="arpuSection" style="display:none;">
      <label>ARPU (‚ÇΩ/–º–µ—Å):</label>
      <input type="number" id="arpu" placeholder="46666">
    </div>
    <div id="annualSection" style="display:none; margin-top:10px;">
      <input type="checkbox" id="annual_contract">
      <label for="annual_contract" style="display:inline;">–ì–æ–¥–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç</label>
    </div>
    <div style="margin-top:15px;">
      <input type="checkbox" id="is_first">
      <label for="is_first" style="display:inline;">–ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ (–¢–û)?</label>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="paid">
      <label for="paid" style="display:inline;">–û–ø–ª–∞—á–µ–Ω?</label>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="up_signed">
      <label for="up_signed" style="display:inline;">–£–ü–î –ø–æ–¥–ø–∏—Å–∞–Ω?</label>
    </div>
    <button id="createDealBtn" class="success">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
    <div id="createFormResult" class="result" style="display:none;"></div>
  `;
  document.getElementById('deal_type').addEventListener('change', () => {
    const isTO = document.getElementById('deal_type').value === 'to';
    document.getElementById('arpuSection').style.display = isTO ? 'block' : 'none';
    document.getElementById('annualSection').style.display = isTO ? 'block' : 'none';
  });
  document.getElementById('deal_type').dispatchEvent(new Event('change'));
  document.getElementById('createDealBtn').addEventListener('click', async () => {
    const managerName = document.getElementById('manager_name').value.trim();
    const contractAmount = parseFloat(document.getElementById('contract_amount').value);
    const paymentAmount = parseFloat(document.getElementById('payment_amount').value);
    const dealType = document.getElementById('deal_type').value;
    const arpuInput = document.getElementById('arpu').value;
    const annualContract = document.getElementById('annual_contract').checked;
    const isFirst = document.getElementById('is_first').checked;
    const paid = document.getElementById('paid').checked;
    const upSigned = document.getElementById('up_signed').checked;
    if (!managerName || isNaN(contractAmount) || isNaN(paymentAmount)) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Å—É–º–º—É –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã');
      return;
    }
    const totalPaid = paymentAmount;
    const isFullyPaid = totalPaid >= contractAmount;
    let bonusPaid = 0;
    if (isFullyPaid) {
      let revenueForBonus = contractAmount;
      if (dealType === 'to') {
        const arpuValue = arpuInput ? parseFloat(arpuInput) : contractAmount / 12;
        revenueForBonus = arpuValue;
      }
      bonusPaid = calculateBonus(dealType, revenueForBonus, isFirst, true, upSigned, annualContract);
    }
    const margin =
      dealType === 'to' || dealType === 'pto' || dealType === 'rent' ? contractAmount * 0.7 :
      dealType === 'eq' ? contractAmount * 0.2 :
      dealType === 'comp' ? contractAmount * 0.3 :
      dealType === 'rep' ? contractAmount * 0.4 : 0;
    const { error } = await supabaseClient
      .from('deals')
      .insert([{
        crm_id: crmId,
        manager_name: managerName,
        deal_type: dealType,
        contract_amount: contractAmount,
        total_paid: totalPaid,
        paid: isFullyPaid,
        up_signed: upSigned,
        is_first: isFirst,
        arpu_input: dealType === 'to' ? (arpuInput ? parseFloat(arpuInput) : null) : null,
        annual_contract: annualContract,
        margin: margin,
        bonus_paid: bonusPaid
      }]);
    if (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
      return;
    }
    document.getElementById('createFormResult').innerHTML = `
      –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!<br>
      –ü—Ä–µ–º–∏—è: ${bonusPaid > 0 ? bonusPaid.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞'}
    `;
    document.getElementById('createFormResult').style.display = 'block';
  });
}

// üîÑ –§–æ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–º–µ–Ω–µ–¥–∂–µ—Ä)
function showUpdateForm(deal) {
  const { crm_id, contract_amount, total_paid, up_signed, paid, manager_name, deal_type, is_first, arpu_input, annual_contract } = deal;
  const remaining = contract_amount - total_paid;
  document.getElementById('crmScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('formContainer').innerHTML = `
    <button id="backBtn" style="margin-bottom:15px; background:#f5f5f5; border:1px solid #ddd; padding:6px 12px; border-radius:6px; cursor:pointer;">
      <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ CRM ID
    </button>
    <h3><i class="fas fa-edit"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–¥–µ–ª–∫—É: ${crm_id}</h3>
    <p><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${manager_name}</p>
    <p><strong>–¢–∏–ø:</strong> ${
      deal_type === 'to' ? '–¢–û' :
      deal_type === 'pto' ? '–ü–¢–û' :
      deal_type === 'eq' ? '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' :
      deal_type === 'comp' ? '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ' :
      deal_type === 'rep' ? '–†–µ–º–æ–Ω—Ç—ã' :
      deal_type === 'rent' ? '–ê—Ä–µ–Ω–¥–∞' : deal_type
    }</p>
    <p><strong>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> ${contract_amount.toLocaleString('ru-RU')} ‚ÇΩ</p>
    <p><strong>–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ:</strong> ${total_paid.toLocaleString('ru-RU')} ‚ÇΩ</p>
    <p style="color:${remaining <= 0 ? 'green' : 'orange'};">
      <strong>–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å:</strong> ${Math.max(0, remaining).toLocaleString('ru-RU')} ‚ÇΩ
    </p>
    <p><strong>–£–ü–î:</strong> ${up_signed ? '‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω' : '‚ùå –ù–µ –ø–æ–¥–ø–∏—Å–∞–Ω'}</p>
    <p><strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã:</strong> ${paid ? '‚úÖ 100%' : '‚è≥ –ß–∞—Å—Ç–∏—á–Ω–∞—è'}</p>
    <label>–°—É–º–º–∞ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (‚ÇΩ):</label>
    <input type="number" id="additional_payment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100000" ${paid ? 'disabled' : ''}>
    <div style="margin-top:15px;">
      <input type="checkbox" id="update_up_signed" ${up_signed ? 'checked disabled' : ''}>
      <label for="update_up_signed" style="display:inline;">–û—Ç–º–µ—Ç–∏—Ç—å –£–ü–î –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π</label>
    </div>
    <button id="updateDealBtn" class="success">–û–±–Ω–æ–≤–∏—Ç—å –£–ü–î</button>
    <div id="updateFormResult" class="result" style="display:none;"></div>
  `;
  document.getElementById('updateDealBtn').addEventListener('click', async () => {
    const additionalPayment = parseFloat(document.getElementById('additional_payment')?.value || 0);
    const newUpSigned = document.getElementById('update_up_signed').checked;
    if (paid && up_signed === newUpSigned) {
      alert('–ù–µ—á–µ–≥–æ –æ–±–Ω–æ–≤–ª—è—Ç—å');
      return;
    }
    if (!paid && (isNaN(additionalPayment) || additionalPayment <= 0)) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞');
      return;
    }
    let newTotalPaid = total_paid;
    let newPaid = paid;
    let bonusPaid = deal.bonus_paid || 0;
    if (!paid) {
      newTotalPaid += additionalPayment;
      newPaid = newTotalPaid >= contract_amount;
      if (newPaid && bonusPaid === 0) {
        let revenueForBonus = contract_amount;
        if (deal_type === 'to') {
          const arpuValue = arpu_input || contract_amount / 12;
          revenueForBonus = arpuValue;
        }
        bonusPaid = calculateBonus(deal_type, revenueForBonus, is_first, true, newUpSigned, annual_contract);
      }
    }
    const { error } = await supabaseClient
      .from('deals')
      .update({
        total_paid: newTotalPaid,
        paid: newPaid,
        up_signed: newUpSigned,
        bonus_paid: bonusPaid,
        updated_at: new Date().toISOString()
      })
      .eq('crm_id', crm_id);
    if (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
      alert('–û—à–∏–±–∫–∞: ' + error.message);
      return;
    }
    document.getElementById('updateFormResult').innerHTML = `
      –°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!<br>
      ${newPaid && bonusPaid > 0 ? `–ù–∞—á–∏—Å–ª–µ–Ω–∞ –ø—Ä–µ–º–∏—è: ${bonusPaid.toLocaleString('ru-RU')} ‚ÇΩ` : '–ü—Ä–µ–º–∏—è –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞'}
    `;
    document.getElementById('updateFormResult').style.display = 'block';
  });
}

// üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –†–û–ü–∞
async function loadRopData() {
  const period = document.getElementById('ropPeriod').value;
  const now = new Date();
  let startDate, endDate;
  if (period === 'week') {
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
    startDate = new Date(now.setDate(diff));
    endDate = new Date(now.setDate(startDate.getDate() + 6));
  } else if (period === 'month') {
    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  } else if (period === 'quarter') {
    const quarter = Math.floor(now.getMonth() / 3);
    startDate = new Date(now.getFullYear(), quarter * 3, 1);
    endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
  } else if (period === 'year') {
    startDate = new Date(now.getFullYear(), 0, 1);
    endDate = new Date(now.getFullYear(), 11, 31);
  }
  endDate.setHours(23, 59, 59, 999);
  const { data, error } = await supabaseClient
    .from('deals')
    .select('crm_id, manager_name, deal_type, contract_amount, margin, total_paid, paid, up_signed, created_at')
    .gte('created_at', startDate.toISOString())
    .lte('created_at', endDate.toISOString());
  if (error) {
    console.error('–û—à–∏–±–∫–∞ Supabase:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    document.getElementById('ropSummary').style.display = 'none';
    document.getElementById('ropDealsTable').style.display = 'none';
    document.getElementById('managersAnalytics').style.display = 'none';
    document.getElementById('segmentsAnalytics').style.display = 'none';
    return;
  }
  const allDeals = data || [];
  // üëá –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–µ
  const managerSet = new Set(allDeals.map(d => d.manager_name));
  const managerSelect = document.getElementById('ropManagerFilter');
  managerSelect.innerHTML = '<option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>';
  managerSet.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    managerSelect.appendChild(opt);
  });
  // üëá –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –§–ò–õ–¨–¢–†–û–í
  const managerFilter = document.getElementById('ropManagerFilter').value;
  const segmentFilter = document.getElementById('ropSegmentFilter').value;
  let deals = allDeals;
  if (managerFilter) {
    deals = deals.filter(d => d.manager_name === managerFilter);
  }
  if (segmentFilter) {
    const typeMap = {
      '–¢–û': 'to', '–ü–¢–û': 'pto', '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': 'eq',
      '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ': 'comp', '–†–µ–º–æ–Ω—Ç—ã': 'rep', '–ê—Ä–µ–Ω–¥–∞': 'rent'
    };
    const dealType = typeMap[segmentFilter];
    deals = deals.filter(d => d.deal_type === dealType);
  }
  // –†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤
  let totalMargin = 0;
  deals.forEach(deal => {
    totalMargin += deal.margin || 0;
  });
  const nds = totalMargin * 0.22;
  const cleanMargin = totalMargin - nds;
  const ropBonus = Math.round(cleanMargin * 0.10);
  document.getElementById('totalMarginRop').textContent = totalMargin.toLocaleString('ru-RU');
  document.getElementById('ropBonus').textContent = ropBonus.toLocaleString('ru-RU');
  document.getElementById('totalDealsRop').textContent = deals.length;
  document.getElementById('ropSummary').style.display = 'block';
  document.getElementById('ropDealsTable').style.display = 'block';
  // üëá –ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–û –ú–ï–ù–ï–î–ñ–ï–†–ê–ú
  const managers = {};
  deals.forEach(d => {
    if (!managers[d.manager_name]) managers[d.manager_name] = 0;
    managers[d.manager_name] += d.margin || 0;
  });
  const managersList = document.getElementById('managersChart');
  managersList.innerHTML = '';
  Object.entries(managers)
    .sort((a, b) => b[1] - a[1])
    .forEach(([name, margin]) => {
      const percent = Math.round((margin / totalMargin) * 100);
      managersList.innerHTML +=
        '<div class="analytics-item">' +
          '<div class="manager-label">' + name + '</div>' +
          '<div class="value">' + margin.toLocaleString('ru-RU') + ' ‚ÇΩ</div>' +
          '<div class="percent">' + percent + '%</div>' +
        '</div>';
    });
  document.getElementById('managersAnalytics').style.display = 'block';
  // üëá –ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–û –°–ï–ì–ú–ï–ù–¢–ê–ú
  const segments = {};
  const typeLabels = {
    'to': '–¢–û', 'pto': '–ü–¢–û', 'eq': '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',
    'comp': '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ', 'rep': '–†–µ–º–æ–Ω—Ç—ã', 'rent': '–ê—Ä–µ–Ω–¥–∞'
  };
  deals.forEach(d => {
    const label = typeLabels[d.deal_type] || d.deal_type;
    if (!segments[label]) segments[label] = 0;
    segments[label] += d.margin || 0;
  });
  const segmentsList = document.getElementById('segmentsChart');
  segmentsList.innerHTML = '';
  Object.entries(segments)
    .sort((a, b) => b[1] - a[1])
    .forEach(([name, margin]) => {
      const percent = Math.round((margin / totalMargin) * 100);
      segmentsList.innerHTML +=
        '<div class="analytics-item">' +
          '<div class="segment-label">' + name + '</div>' +
          '<div class="value">' + margin.toLocaleString('ru-RU') + ' ‚ÇΩ</div>' +
          '<div class="percent">' + percent + '%</div>' +
        '</div>';
    });
  document.getElementById('segmentsAnalytics').style.display = 'block';
  // üëá –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´
  const tbody = document.getElementById('ropDealsBody');
  tbody.innerHTML = '';
  deals.forEach(deal => {
    const status = deal.paid ? '‚úÖ 100%' : `‚è≥ ${Math.round((deal.total_paid / deal.contract_amount) * 100)}%`;
    const updStatus = deal.up_signed ? '<span class="status-icon icon-success">‚úîÔ∏è</span>' : '<span class="status-icon icon-danger">‚úñÔ∏è</span>';
    const typeLabel =
      deal.deal_type === 'to' ? '–¢–û' :
      deal.deal_type === 'pto' ? '–ü–¢–û' :
      deal.deal_type === 'eq' ? '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' :
      deal.deal_type === 'comp' ? '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ' :
      deal.deal_type === 'rep' ? '–†–µ–º–æ–Ω—Ç—ã' :
      deal.deal_type === 'rent' ? '–ê—Ä–µ–Ω–¥–∞' : deal.deal_type;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="no-wrap">${deal.crm_id}</td>
      <td class="no-wrap">${deal.manager_name}</td>
      <td class="no-wrap">${typeLabel}</td>
      <td class="no-wrap">${deal.contract_amount.toLocaleString('ru-RU')} ‚ÇΩ</td>
      <td class="no-wrap"><span class="margin-value">${(deal.margin || 0).toLocaleString('ru-RU')} ‚ÇΩ</span></td>
      <td class="no-wrap">${status}</td>
      <td class="no-wrap">${updStatus}</td>
      <td>
        <button class="editDealBtn" data-crm-id="${deal.crm_id}" style="background:var(--primary); color:white; border:none; padding:4px 8px; border-radius:4px; font-size:14px;">
          ‚úèÔ∏è –†–µ–¥–∞–∫—Ç.
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// ‚ûï –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –æ—Ç –†–û–ü–∞
document.getElementById('ropCreateDealBtn').addEventListener('click', () => {
  const crmId = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏ –∏–∑ CRM:');
  if (crmId) {
    showRopCreateForm(crmId.trim());
  }
});

// ‚ûï –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è –†–û–ü–∞
function showRopCreateForm(crmId) {
  document.getElementById('ropScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('formContainer').innerHTML = `
    <button id="backToRopBtn" style="margin-bottom:15px; background:#f5f5f5; border:1px solid #ddd; padding:6px 12px; border-radius:6px; cursor:pointer;">
      <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ –†–û–ü–∞
    </button>
    <h3><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É (–†–û–ü): ${crmId}</h3>
    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <select id="ropManagerName">
      <option value="–ò–ª—å—è –ì–∞–ª—É–Ω–∏–Ω">–ò–ª—å—è –ì–∞–ª—É–Ω–∏–Ω</option>
      <option value="–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞">–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞</option>
    </select>
    <label>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (‚ÇΩ):</label>
    <input type="number" id="ropContractAmount" placeholder="600000" required>
    <label>–°—É–º–º–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã (‚ÇΩ):</label>
    <input type="number" id="ropPaymentAmount" placeholder="140000" required>
    <label>–¢–∏–ø —Å–¥–µ–ª–∫–∏:</label>
    <select id="ropDealType">
      <option value="to">–¢–û</option>
      <option value="pto">–ü–¢–û</option>
      <option value="comp">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</option>
      <option value="rep">–†–µ–º–æ–Ω—Ç—ã</option>
      <option value="eq">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
      <option value="rent">–ê—Ä–µ–Ω–¥–∞</option>
    </select>
    <div id="ropArpuSection" style="display:none;">
      <label>ARPU (‚ÇΩ/–º–µ—Å):</label>
      <input type="number" id="ropArpu" placeholder="46666">
    </div>
    <div id="ropAnnualSection" style="display:none; margin-top:10px;">
      <input type="checkbox" id="ropAnnualContract">
      <label for="ropAnnualContract" style="display:inline;">–ì–æ–¥–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç</label>
    </div>
    <div style="margin-top:15px;">
      <input type="checkbox" id="ropIsFirst">
      <label for="ropIsFirst" style="display:inline;">–ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ (–¢–û)?</label>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="ropPaid">
      <label for="ropPaid" style="display:inline;">–û–ø–ª–∞—á–µ–Ω?</label>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="ropUpdSigned">
      <label for="ropUpdSigned" style="display:inline;">–£–ü–î –ø–æ–¥–ø–∏—Å–∞–Ω?</label>
    </div>
    <button id="ropCreateDealBtn" class="success">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
    <div id="ropCreateFormResult" class="result" style="display:none;"></div>
  `;
  document.getElementById('ropDealType').addEventListener('change', () => {
    const isTO = document.getElementById('ropDealType').value === 'to';
    document.getElementById('ropArpuSection').style.display = isTO ? 'block' : 'none';
    document.getElementById('ropAnnualSection').style.display = isTO ? 'block' : 'none';
  });
  document.getElementById('ropDealType').dispatchEvent(new Event('change'));
  document.getElementById('ropCreateDealBtn').addEventListener('click', async () => {
    const managerName = document.getElementById('ropManagerName').value;
    const contractAmount = parseFloat(document.getElementById('ropContractAmount').value);
    const paymentAmount = parseFloat(document.getElementById('ropPaymentAmount').value);
    const dealType = document.getElementById('ropDealType').value;
    const arpuInput = document.getElementById('ropArpu').value;
    const annualContract = document.getElementById('ropAnnualContract').checked;
    const isFirst = document.getElementById('ropIsFirst').checked;
    const paid = document.getElementById('ropPaid').checked;
    const upSigned = document.getElementById('ropUpdSigned').checked;
    if (!managerName || isNaN(contractAmount) || isNaN(paymentAmount)) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }
    const totalPaid = paymentAmount;
    const isFullyPaid = totalPaid >= contractAmount;
    let bonusPaid = 0;
    if (isFullyPaid) {
      let revenueForBonus = contractAmount;
      if (dealType === 'to') {
        const arpuValue = arpuInput ? parseFloat(arpuInput) : contractAmount / 12;
        revenueForBonus = arpuValue;
      }
      bonusPaid = calculateBonus(dealType, revenueForBonus, isFirst, true, upSigned, annualContract);
    }
    const margin =
      dealType === 'to' || dealType === 'pto' || dealType === 'rent' ? contractAmount * 0.7 :
      dealType === 'eq' ? contractAmount * 0.2 :
      dealType === 'comp' ? contractAmount * 0.3 :
      dealType === 'rep' ? contractAmount * 0.4 : 0;
    const { error } = await supabaseClient
      .from('deals')
      .insert([{
        crm_id: crmId,
        manager_name: managerName,
        deal_type: dealType,
        contract_amount: contractAmount,
        total_paid: totalPaid,
        paid: isFullyPaid,
        up_signed: upSigned,
        is_first: isFirst,
        arpu_input: dealType === 'to' ? (arpuInput ? parseFloat(arpuInput) : null) : null,
        annual_contract: annualContract,
        margin: margin,
        bonus_paid: bonusPaid
      }]);
    if (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
      return;
    }
    document.getElementById('ropCreateFormResult').innerHTML = '‚úÖ –°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!';
    document.getElementById('ropCreateFormResult').style.display = 'block';
    setTimeout(() => {
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('ropScreen').style.display = 'block';
      loadRopData();
    }, 2000);
  });
}

// üñäÔ∏è –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –†–û–ü–∞
function showRopUpdateForm(deal) {
  document.getElementById('ropScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  const { crm_id, contract_amount, total_paid, up_signed, paid, manager_name, deal_type, is_first, arpu_input, annual_contract } = deal;
  const remaining = contract_amount - total_paid;
  document.getElementById('formContainer').innerHTML = `
    <button id="backToRopBtn" style="margin-bottom:15px; background:#f5f5f5; border:1px solid #ddd; padding:6px 12px; border-radius:6px; cursor:pointer;">
      <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ –†–û–ü–∞
    </button>
    <h3><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É (–†–û–ü): ${crm_id}</h3>
    <p><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${manager_name}</p>
    <p><strong>–¢–∏–ø:</strong> ${
      deal_type === 'to' ? '–¢–û' :
      deal_type === 'pto' ? '–ü–¢–û' :
      deal_type === 'eq' ? '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' :
      deal_type === 'comp' ? '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ' :
      deal_type === 'rep' ? '–†–µ–º–æ–Ω—Ç—ã' :
      deal_type === 'rent' ? '–ê—Ä–µ–Ω–¥–∞' : deal_type
    }</p>
    <p><strong>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:</strong> ${contract_amount.toLocaleString('ru-RU')} ‚ÇΩ</p>
    <p><strong>–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ:</strong> ${total_paid.toLocaleString('ru-RU')} ‚ÇΩ</p>
    <p style="color:${remaining <= 0 ? 'green' : 'orange'};">
      <strong>–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å:</strong> ${Math.max(0, remaining).toLocaleString('ru-RU')} ‚ÇΩ
    </p>
    <label>–ù–æ–≤–∞—è —Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã (‚ÇΩ):</label>
    <input type="number" id="ropPaymentAmount" value="${total_paid}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 140000">
    <div style="margin-top:15px;">
      <input type="checkbox" id="ropPaid" ${paid ? 'checked' : ''}>
      <label for="ropPaid" style="display:inline;">–û–ø–ª–∞—á–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é</label>
    </div>
    <div style="margin-top:10px;">
      <input type="checkbox" id="ropUpdSigned" ${up_signed ? 'checked' : ''}>
      <label for="ropUpdSigned" style="display:inline;">–£–ü–î –ø–æ–¥–ø–∏—Å–∞–Ω</label>
    </div>
    <button id="saveRopDealBtn" class="success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    <div id="ropUpdateResult" class="result" style="display:none; margin-top:15px;"></div>
  `;
  document.getElementById('saveRopDealBtn').addEventListener('click', async () => {
    const newPayment = parseFloat(document.getElementById('ropPaymentAmount').value) || total_paid;
    const newPaid = document.getElementById('ropPaid').checked;
    const newUpd = document.getElementById('ropUpdSigned').checked;
    const { error } = await supabaseClient
      .from('deals')
      .update({
        total_paid: newPayment,
        paid: newPaid,
        up_signed: newUpd,
        updated_at: new Date().toISOString()
      })
      .eq('crm_id', crm_id);
    if (error) {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
      return;
    }
    document.getElementById('ropUpdateResult').innerHTML = '‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
    document.getElementById('ropUpdateResult').style.display = 'block';
    setTimeout(() => {
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('ropScreen').style.display = 'block';
      loadRopData();
    }, 2000);
  });
}

// üîô –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫
document.addEventListener('click', (e) => {
  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" (–º–µ–Ω–µ–¥–∂–µ—Ä)
  if (e.target.id === 'backBtn') {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('crmScreen').style.display = 'block';
    document.getElementById('monthResult').style.display = 'none';
  }
  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –†–û–ü—É"
  if (e.target.id === 'backToRopBtn') {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('ropScreen').style.display = 'block';
  }
  // –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" (–†–û–ü)
  if (e.target.classList.contains('editDealBtn')) {
    const crmId = e.target.getAttribute('data-crm-id');
    supabaseClient
      .from('deals')
      .select('*')
      .eq('crm_id', crmId)
      .single()
      .then(({ data, error }) => {
        if (error) {
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–¥–µ–ª–∫–∏: ' + error.message);
          return;
        }
        if (data) {
          showRopUpdateForm(data);
        }
      });
  }
});

// üîÑ –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –†–û–ü–∞
document.getElementById('loadRopData').addEventListener('click', loadRopData);
// üîÑ –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.getElementById('applyRopFilters').addEventListener('click', loadRopData);
});
</script>
</body>
</html>
